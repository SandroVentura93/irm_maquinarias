<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Formulario de Cliente - IRM Maquinarias S.R.L.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-bug text-danger"></i> Prueba de Formulario de Cliente</h2>
                <p class="text-muted">Esta p√°gina permite probar la funcionalidad de b√∫squeda de clientes paso a paso.</p>
            </div>
        </div>

        <div class="row">
            <!-- Panel de prueba -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> B√∫squeda de Cliente</h5>
                    </div>
                    <div class="card-body">
                        <!-- Buscador -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="buscar_documento" class="form-label">
                                    <i class="fas fa-id-card text-primary"></i> RUC/DNI Cliente
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="buscar_documento" 
                                           placeholder="Ingrese RUC (11 d√≠gitos) o DNI (8 d√≠gitos)"
                                           maxlength="11"
                                           value="12345678">
                                    <button type="button" 
                                            class="btn btn-info" 
                                            id="btnBuscarCliente">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pruebas R√°pidas:</label><br>
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="probarDocumento('12345678')">DNI: 12345678</button>
                                <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="probarDocumento('20556677889')">RUC: 20556677889</button>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="probarDocumento('99999999')">No Existe</button>
                            </div>
                        </div>

                        <!-- Campos de resultado -->
                        <div class="row">
                            <div class="col-md-4">
                                <label for="cliente_nombre">Nombre/Raz√≥n Social</label>
                                <input type="text" class="form-control bg-light" id="cliente_nombre" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="cliente_direccion">Direcci√≥n</label>
                                <input type="text" class="form-control bg-light" id="cliente_direccion" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="cliente_telefono">Tel√©fono</label>
                                <input type="text" class="form-control bg-light" id="cliente_telefono" readonly>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="cliente_correo">Correo</label>
                                <input type="text" class="form-control bg-light" id="cliente_correo" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="cliente_ubigeo">Ubigeo</label>
                                <input type="text" class="form-control bg-light" id="cliente_ubigeo" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="cliente_estado">Estado</label>
                                <input type="text" class="form-control bg-light" id="cliente_estado" readonly>
                            </div>
                        </div>

                        <!-- Mensaje -->
                        <div id="mensajeCliente" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <span id="textoMensaje"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de debug -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code text-success"></i> Debug Info</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-log" class="debug-info" style="height: 400px; overflow-y: scroll;">
                            <strong>üöÄ Prueba inicializada</strong><br>
                            Esperando interacci√≥n del usuario...<br><br>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="limpiarLog()">
                            <i class="fas fa-trash"></i> Limpiar Log
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para debug
        let debugLog = document.getElementById('debug-log');
        
        function log(mensaje) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${mensaje}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(mensaje);
        }

        function limpiarLog() {
            debugLog.innerHTML = '<strong>üßπ Log limpiado</strong><br>';
        }

        function probarDocumento(documento) {
            document.getElementById('buscar_documento').value = documento;
            log(`üìù Documento establecido: ${documento}`);
            buscarClientePorDocumento();
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üìÑ DOM cargado completamente');
            
            const btnBuscar = document.getElementById('btnBuscarCliente');
            if (btnBuscar) {
                btnBuscar.addEventListener('click', function(e) {
                    e.preventDefault();
                    log('üñ±Ô∏è Click en bot√≥n buscar detectado');
                    buscarClientePorDocumento();
                });
                log('‚úÖ Event listener del bot√≥n configurado');
            } else {
                log('‚ùå No se encontr√≥ el bot√≥n de b√∫squeda');
            }

            const inputDocumento = document.getElementById('buscar_documento');
            if (inputDocumento) {
                inputDocumento.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        log('‚å®Ô∏è Enter presionado en input documento');
                        buscarClientePorDocumento();
                    }
                });
                log('‚úÖ Event listener del input configurado');
            } else {
                log('‚ùå No se encontr√≥ el input de documento');
            }

            log('üéâ Configuraci√≥n completa - Listo para pruebas');
        });

        function buscarClientePorDocumento() {
            log('üîç === INICIANDO B√öSQUEDA ===');
            
            try {
                const inputDocumento = document.getElementById('buscar_documento');
                if (!inputDocumento) {
                    log('‚ùå Error: Input documento no encontrado');
                    return;
                }
                
                const documento = inputDocumento.value.trim();
                log(`üìÑ Documento a buscar: "${documento}"`);
                
                if (!documento) {
                    log('‚ö†Ô∏è Warning: Documento vac√≠o');
                    mostrarMensaje('Por favor ingrese un RUC o DNI', 'warning');
                    return;
                }
                
                if (!/^\d+$/.test(documento)) {
                    log('‚ùå Error: Documento contiene caracteres no num√©ricos');
                    mostrarMensaje('El documento debe contener solo n√∫meros', 'danger');
                    return;
                }
                
                if (documento.length < 8 || documento.length > 11) {
                    log('‚ùå Error: Longitud de documento inv√°lida');
                    mostrarMensaje('El documento debe tener entre 8 y 11 d√≠gitos', 'danger');
                    return;
                }
                
                log('‚úÖ Validaciones pasadas, consultando API...');
                mostrarMensaje('üîç Buscando cliente...', 'info');
                
                consultarAPI(documento);
                
            } catch (error) {
                log(`‚ùå Error en buscarClientePorDocumento: ${error.message}`);
                mostrarMensaje('Error interno: ' + error.message, 'danger');
            }
        }

        function consultarAPI(documento) {
            log('üåê === CONSULTANDO API ===');
            
            const url = `/api/clientes/buscar/${encodeURIComponent(documento)}`;
            log(`üì° URL: ${url}`);
            
            const startTime = Date.now();
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                const duration = Date.now() - startTime;
                log(`üì° Respuesta recibida en ${duration}ms`);
                log(`üìä Status: ${response.status}`);
                log(`üìä Status Text: ${response.statusText}`);
                
                if (response.status === 404) {
                    log('‚ÑπÔ∏è Cliente no encontrado (404)');
                    mostrarMensaje('Cliente no encontrado en la base de datos', 'warning');
                    limpiarCampos();
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                log('‚úÖ Respuesta OK, parseando JSON...');
                return response.json();
            })
            .then(data => {
                if (data === null) {
                    log('‚ÑπÔ∏è Datos nulos (cliente no encontrado)');
                    return;
                }
                
                log('üìä === DATOS RECIBIDOS ===');
                log(`Datos completos: ${JSON.stringify(data, null, 2)}`);
                
                if (data && data.id) {
                    log('‚úÖ Cliente encontrado, procesando datos...');
                    procesarDatosCliente(data);
                } else {
                    log('‚ùå Estructura de datos inv√°lida');
                    mostrarMensaje('Error: Datos del cliente inv√°lidos', 'danger');
                }
            })
            .catch(error => {
                const duration = Date.now() - startTime;
                log(`‚ùå Error despu√©s de ${duration}ms: ${error.message}`);
                mostrarMensaje('Error al consultar: ' + error.message, 'danger');
            });
        }

        function procesarDatosCliente(data) {
            log('üîÑ === PROCESANDO DATOS DEL CLIENTE ===');
            
            const campos = {
                'cliente_nombre': data.nombre || 'No disponible',
                'cliente_direccion': data.direccion || 'No disponible',
                'cliente_telefono': data.telefono || 'No disponible',
                'cliente_correo': data.correo || 'No disponible',
                'cliente_ubigeo': data.id_ubigeo || 'No disponible',
                'cliente_estado': data.activo ? 'Activo' : 'Inactivo'
            };
            
            log('üìù Campos a llenar:');
            Object.keys(campos).forEach(campo => {
                log(`  - ${campo}: "${campos[campo]}"`);
            });
            
            // Llenar campos
            let camposLlenados = 0;
            Object.keys(campos).forEach(campoId => {
                const elemento = document.getElementById(campoId);
                if (elemento) {
                    elemento.value = campos[campoId];
                    elemento.classList.add('is-valid');
                    log(`‚úÖ ${campoId} llenado correctamente`);
                    camposLlenados++;
                } else {
                    log(`‚ùå Campo ${campoId} no encontrado en DOM`);
                }
            });
            
            log(`üìä Resumen: ${camposLlenados}/${Object.keys(campos).length} campos llenados`);
            
            if (camposLlenados > 0) {
                mostrarMensaje(`‚úÖ Cliente encontrado: ${data.nombre}`, 'success');
            } else {
                mostrarMensaje('‚ùå Error al llenar los campos', 'danger');
            }
        }

        function limpiarCampos() {
            log('üßπ Limpiando campos...');
            
            const campos = [
                'cliente_nombre', 'cliente_direccion', 'cliente_telefono',
                'cliente_correo', 'cliente_ubigeo', 'cliente_estado'
            ];
            
            campos.forEach(campoId => {
                const elemento = document.getElementById(campoId);
                if (elemento) {
                    elemento.value = '';
                    elemento.classList.remove('is-valid', 'is-invalid');
                }
            });
            
            log('‚úÖ Campos limpiados');
        }

        function mostrarMensaje(texto, tipo) {
            const mensajeDiv = document.getElementById('mensajeCliente');
            const textoSpan = document.getElementById('textoMensaje');
            const alertDiv = mensajeDiv.querySelector('.alert');
            
            alertDiv.classList.remove('alert-info', 'alert-success', 'alert-warning', 'alert-danger');
            alertDiv.classList.add(`alert-${tipo}`);
            
            textoSpan.textContent = texto;
            mensajeDiv.style.display = 'block';
            
            log(`üí¨ Mensaje mostrado (${tipo}): ${texto}`);
        }

        // Prueba autom√°tica al cargar
        window.addEventListener('load', function() {
            log('üöÄ P√°gina completamente cargada');
            log('‚ÑπÔ∏è Puede usar los botones de "Pruebas R√°pidas" o escribir un documento manualmente');
        });
    </script>
</body>
</html>